# 长图OCR处理系统

这是一个重构后的长图OCR处理系统，将原始的单文件代码重构为模块化的架构，提高了代码的可读性和可维护性。

## 项目结构

```
├── src/                          # 源代码目录
│   ├── __init__.py              # 包初始化文件
│   ├── config.py                # 配置管理模块
│   ├── image_slicer.py          # 图像切分模块
│   ├── ocr_processor.py         # OCR处理模块
│   ├── avatar_detector.py       # 头像检测模块
│   ├── deduplicator.py          # 去重处理模块
│   ├── content_marker.py        # 内容标记模块
│   ├── chat_organizer.py        # 聊天消息组织模块
│   ├── data_exporter.py         # 数据导出模块
│   └── long_image_ocr.py        # 主处理模块
├── main.py                      # 主程序入口
├── LLM_run.py                   # LLM交互模块（保持原有）
├── process_avatar.py            # 头像处理模块（保持原有）
├── default_rapidocr.yaml       # OCR配置文件
└── README.md                    # 项目说明文档
```

## 模块说明

### 1. Config (配置管理模块)
- 统一管理所有配置参数
- 自动创建输出目录
- 提供配置获取接口

### 2. ImageSlicer (图像切分模块)
- 负责长图的切分处理
- 支持重叠区域设置
- 自动保存切片图像

### 3. OCRProcessor (OCR处理模块)
- 使用RapidOCR进行文本识别
- 过滤低置信度结果
- 坐标转换和结果排序

### 4. AvatarDetector (头像检测模块)
- 检测聊天界面中的头像位置
- 计算x_croped裁剪参数
- 支持多种头像检测策略

### 5. Deduplicator (去重处理模块)
- OCR结果去重
- 头像位置去重
- 基于IoU的重复检测

### 6. ContentMarker (内容标记模块)
- 时间内容标记
- 昵称和内容标记
- 颜色背景检测（绿色/蓝色）

### 7. ChatOrganizer (聊天消息组织模块)
- 将标记后的文本组织成结构化消息
- 支持多种消息类型识别
- 智能昵称分析

### 8. DataExporter (数据导出模块)
- 导出标记后的OCR结果
- 导出结构化聊天消息
- 导出汇总数据

### 9. LongImageOCR (主处理模块)
- 协调各个模块的工作
- 提供完整的处理流程
- 管理处理结果

## 使用方法

1. 安装依赖：
```bash
pip install rapidocr opencv-python numpy scikit-learn requests
```

2. 运行程序：
```bash
python main.py
```

3. 程序会自动处理指定的长图，并生成以下输出：
   - `output_images/`: 切片图像和可视化结果
   - `output_json/`: JSON格式的处理结果

## 重构改进

### 1. 模块化设计
- 将原始的3000+行单文件拆分为9个专门的模块
- 每个模块职责单一，便于维护和测试
- 模块间通过清晰的接口进行交互

### 2. 配置管理
- 统一的配置管理，避免硬编码
- 支持灵活的参数调整
- 自动创建必要的输出目录

### 3. 错误处理
- 改进了异常处理机制
- 提供更清晰的错误信息
- 增强了程序的健壮性

### 4. 代码可读性
- 清晰的函数命名和文档字符串
- 合理的代码组织结构
- 减少了代码重复

### 5. 扩展性
- 模块化设计便于功能扩展
- 支持不同的OCR引擎和检测算法
- 易于添加新的处理步骤

## 与原版本的兼容性

重构后的代码与原版本在功能上完全兼容：
- 处理效果完全一致
- 输出格式保持不变
- 支持相同的配置参数
- 保留了所有核心功能

## 注意事项

1. 确保图像文件路径正确
2. 检查OCR配置文件是否存在
3. 确保有足够的磁盘空间存储输出文件
4. 如需与LLM交互，确保Ollama服务正在运行

## 开发者指南

如需修改或扩展功能：

1. **添加新的处理步骤**：在相应模块中添加方法，并在主处理流程中调用
2. **修改配置参数**：在`Config`类中添加新的配置项
3. **更换OCR引擎**：修改`OCRProcessor`模块
4. **添加新的导出格式**：扩展`DataExporter`模块

## 许可证

本项目遵循原项目的许可证条款。